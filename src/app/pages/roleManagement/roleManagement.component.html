<h1>User Roles</h1>

<nb-card>
  <nb-card-header>Use the tabs below to manage users; you can add & disable users, as well as change their role status
  </nb-card-header>
  <nb-card-body>
    <nb-tabset>
      <nb-tab tabTitle="Add Users" tabIcon="person-add-outline" responsive>
        <form class="text-center" (ngSubmit)="createUser()" #form="ngForm" aria-labelledby="title">
          <div *ngIf="!isLoading()">
          <ng-container>
            <h6>To create a new user please enter the email address of the user you want to create, a password will be
              automatically generated (but you can change it if you want). Finally, select the role the user is to have
              within
              the system (roles can be managed after creation)</h6>

            <br>
            <h6>Users Email</h6>
            <br>
            <div class="form-control-group">
              <input nbInput [(ngModel)]="userRegistration.email" #email="ngModel" id="input-email" name="email"
                placeholder="Enter Email" autofocus fieldSize="medium"
                [status]="email.dirty ? (email.invalid  ? 'danger' : 'success') : 'basic'" [required]=true
                [attr.aria-invalid]="email.invalid && email.touched ? true : null" [pattern]=emailPattern>
              <ng-container *ngIf="email.invalid && email.touched">
                <p class="caption status-danger" *ngIf="email.errors?.required">
                  email is invalid, please enter a email address
                </p>
                <p class="caption status-danger" *ngIf="email.errors?.pattern">
                  email is invalid, please enter a email address
                </p>
              </ng-container>
            </div>

            <br>
            <h6>Users Password</h6>

            <br>

            <div class="input-group mb-3 justify-content-center">
              <input nbInput [(ngModel)]="userRegistration.password" #password="ngModel" id="input-password"
                name="password" placeholder="Enter password" autofocus fieldSize="medium" (focus)="generatePassword()"
                [status]="password.dirty ? (password.invalid  ? 'danger' : 'success') : 'basic'" [required]=true
                [attr.aria-invalid]="password.invalid && password.touched ? true : null" minlength="8" maxlength="20">
              <ng-container *ngIf="password.invalid && password.touched">
                <p class="caption status-danger" *ngIf="password.errors?.required">
                  password is invalid, please enter a password address
                </p>
              </ng-container>
              &nbsp;&nbsp;
              <div class="input-group-append">
                <button class="btn btn-outline-secondary" nbButton type="button" status="info" size="large"
                  (click)="generatePassword()">
                  Generate New
                </button>
              </div>
            </div>

            <br>
            <h6>Users Role</h6>
            <br>

            <div class="form-control-group">
              <nb-radio-group id="role" name="role" [(ngModel)]="userRegistration.role" #role="ngModel">
                <nb-radio class="inline-radio" *ngFor="let role of roles" [value]=role>{{role}}
                </nb-radio>
              </nb-radio-group>
            </div>

            <br>

            <button nbButton fullWidth status="primary" size="large" [disabled]="submitted || !form.valid"
              [class.btn-pulse]="submitted">
              Register {{userRegistration.email}}
            </button>
            
          </ng-container>
        </div>
          <div *ngIf="isLoading()">
            <nb-card [nbSpinner]="true" nbSpinnerSize="giant" nbSpinnerStatus="primary">
              <nb-card-body>
                Processing
              </nb-card-body>
            </nb-card>
          </div>
        </form>
      </nb-tab>
      <nb-tab tabTitle="Manage Existing Users" tabIcon="clipboard-outline" responsive>

        <h6>Options</h6>

        <h6>To search for a user please enter their full email address in the box below. the entire email address must
          be entered in, e.g.
          if you you want to search for 'info@oceansignal.com' then entering 'info@' will not return any results.
        </h6>

        <form class="text-center" (ngSubmit)="searchUser()" (keyup.enter)="searchUser()" #formEditUser="ngForm"
          aria-labelledby="title">

          <div class="input-group mb-3 justify-content-center">
            <ng-container>
              <input nbInput [(ngModel)]="userEmailSearch" #emailSearch="ngModel" id="input-searchUser"
                name="emailSearch" placeholder="Enter Email" autofocus fieldSize="medium"
                [status]="emailSearch.dirty ? (emailSearch.invalid  ? 'danger' : 'success') : 'basic'" [required]=true
                [attr.aria-invalid]="emailSearch.invalid && emailSearch.touched ? true : null" [pattern]=emailPattern>
              <ng-container *ngIf="emailSearch.invalid && emailSearch.touched">
                <p class="caption status-danger" *ngIf="emailSearch.errors?.required">
                  email is invalid, please enter a email address
                </p>
                <p class="caption status-danger" *ngIf="email.errors?.pattern">
                  email is invalid, please enter a email address
                </p>
              </ng-container>
              &nbsp;&nbsp;

              <button nbButton status="primary" size="large" [disabled]="submitted || !formEditUser.valid"
                [class.btn-pulse]="submitted">
                Search
              </button>

            </ng-container>
          </div>

        </form>

        <div *ngIf="user$ | async; then let userId">
          <nb-accordion>
            <nb-accordion-item>
              <nb-accordion-item-header>{{userId.record.email}} ({{userId.record.uid}})</nb-accordion-item-header>
              <nb-accordion-item-body>
                <div class="text-center">
                  <h6>Account Status</h6>
                  <hr>
                  <br>
                  <div *ngIf="userId.record.disabled;then showEnable else showDisable"></div>
                  <ng-template #showEnable>
                    <p>Current Status: Disabled</p>
                    <button nbButton status="primary" size="large"
                      (click)="setAccountDisabled(userId.record.uid, false)">
                      Enable Account
                    </button>
                  </ng-template>
                  <ng-template #showDisable>
                    <p>Current Status: Enabled</p>
                    <button nbButton status="primary" size="large"
                      (click)="setAccountDisabled(userId.record.uid, true)">
                      Disable Account
                    </button>
                  </ng-template>
                  <br>
                  <br>
                  <h6>User Role</h6>
                </div>
                <hr>
                <div class="input-group mb-3 justify-content-center">
                  <ng-container>
                    <div class="form-control-group">
                      <nb-radio-group id="role" name="role" [(ngModel)]="userEditRole" #role="ngModel">
                        <nb-radio class="inline-radio" *ngFor="let role of roles" [value]=role>{{role}}
                        </nb-radio>
                      </nb-radio-group>
                    </div>

                    &nbsp;&nbsp;

                    <button nbButton status="primary" size="large" (click)="updateUserRole(userId.record.uid)">
                      Update role
                    </button>

                  </ng-container>
                </div>

              </nb-accordion-item-body>
            </nb-accordion-item>
          </nb-accordion>
        </div>

        <div *ngIf="isLoading()">
          <nb-card [nbSpinner]="true" nbSpinnerSize="giant" nbSpinnerStatus="primary">
            <nb-card-body>
              Processing
            </nb-card-body>
          </nb-card>
        </div>

        <div *ngIf="noResultsFound">
          <h6 class="text-warning">{{errorMessage}}</h6>
        </div>

      </nb-tab>
    </nb-tabset>
  </nb-card-body>
</nb-card>